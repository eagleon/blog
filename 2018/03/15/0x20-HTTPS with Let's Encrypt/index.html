<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>0x20-HTTPS with Let&#39;s Encrypt | 大侠曾</title>

  
  <meta name="author" content="大侠曾">
  

  
  <meta name="description" content="HTTPS指南Let’s Encrypt 开始支持通配符证书， 这里是我总结的一个操作指南， 这里使用acme.sh进行配置。
1. 安装openresty参照： http://openresty.org/en/linux-packages.html
2. 配置openresty为服务参考：http">
  

  
  
  <meta name="keywords" content="">
  

  <meta id="viewport" name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">

  <meta property="og:title" content="0x20-HTTPS with Let&#39;s Encrypt"/>

  <meta property="og:site_name" content="大侠曾"/>

  
  <meta property="og:image" content="/favicon.ico"/>
  

  <link href="/favicon.ico" rel="icon">
  <link rel="alternate" href="/atom.xml" title="大侠曾" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
<meta name="generator" content="Hexo 6.3.0"></head>


<body>
<div class="blog">
  <div class="content">

    <header>
  <div class="site-branding">
    <h1 class="site-title">
      <a href="/">大侠曾</a>
    </h1>
    <p class="site-description"></p>
  </div>
  <nav class="site-navigation">
    <ul>
      
        <li><a href="/">主页</a></li>
      
        <li><a href="/archives">归档</a></li>
      
        <li><a href="/about">关于</a></li>
      
    </ul>
  </nav>
</header>

    <main class="site-main posts-loop">
    <article>

  
    
    <h3 class="article-title"><span>0x20-HTTPS with Let&#39;s Encrypt</span></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2018/03/15/0x20-HTTPS with Let's Encrypt/" rel="bookmark">
        <time class="entry-date published" datetime="2018-03-15T11:45:13.000Z">
          2018-03-15
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <span id="more"></span>

<h3 id="HTTPS指南"><a href="#HTTPS指南" class="headerlink" title="HTTPS指南"></a>HTTPS指南</h3><p>Let’s Encrypt 开始支持通配符证书， 这里是我总结的一个操作指南， 这里使用acme.sh进行配置。</p>
<h4 id="1-安装openresty"><a href="#1-安装openresty" class="headerlink" title="1. 安装openresty"></a>1. 安装openresty</h4><p>参照： <a target="_blank" rel="noopener" href="http://openresty.org/en/linux-packages.html">http://openresty.org/en/linux-packages.html</a></p>
<h4 id="2-配置openresty为服务"><a href="#2-配置openresty为服务" class="headerlink" title="2. 配置openresty为服务"></a>2. 配置openresty为服务</h4><p>参考：<a target="_blank" rel="noopener" href="https://kleshwong.com/blog/2017/01/05/setup-lua-resty-auto-ssl-in-ubuntu/">https://kleshwong.com/blog/2017/01/05/setup-lua-resty-auto-ssl-in-ubuntu/</a></p>
<blockquote>
<p>sudo vim &#x2F;etc&#x2F;systemd&#x2F;system&#x2F;nginx.service</p>
</blockquote>
<p>nginx.service</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[Unit]</span><br><span class="line">Description=The nginx HTTP and reverse proxy server</span><br><span class="line">After=syslog.target network.target remote-fs.target nss-lookup.target</span><br><span class="line">[Service]</span><br><span class="line">Type=forking</span><br><span class="line">PIDFile=/usr/local/openresty/nginx/logs/nginx.pid</span><br><span class="line">ExecStartPre=/usr/local/openresty/nginx/sbin/nginx -t</span><br><span class="line">ExecStart=/usr/local/openresty/nginx/sbin/nginx</span><br><span class="line">ExecReload=/bin/kill -s HUP $MAINPID</span><br><span class="line">ExecStop=/bin/kill -s QUIT $MAINPID</span><br><span class="line">PrivateTmp=true</span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure>
<p>启用：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ sudo systemctl <span class="built_in">enable</span> nginx</span><br><span class="line">$ sudo systemctl start nginx</span><br></pre></td></tr></table></figure>

<p>通过 <code>systemctl status nginx </code>可以看到 nginx 是不是正常启动了。若是失败这里也会输出用的日志信息。</p>
<h4 id="3-安装acme-sh"><a href="#3-安装acme-sh" class="headerlink" title="3. 安装acme.sh"></a>3. 安装acme.sh</h4><blockquote>
<p>curl <a target="_blank" rel="noopener" href="https://get.acme.sh/">https://get.acme.sh</a> | sh</p>
</blockquote>
<h4 id="4-配置域名AccessKey"><a href="#4-配置域名AccessKey" class="headerlink" title="4. 配置域名AccessKey"></a>4. 配置域名AccessKey</h4><p>参照：<a target="_blank" rel="noopener" href="https://github.com/Neilpang/acme.sh/tree/master/dnsapi">https://github.com/Neilpang/acme.sh/tree/master/dnsapi</a></p>
<h4 id="5-复制证书到对应位置"><a href="#5-复制证书到对应位置" class="headerlink" title="5. 复制证书到对应位置"></a>5. 复制证书到对应位置</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">acme.sh --install-cert -d chuqufeng.cn \</span><br><span class="line">--key-file       /usr/local/openresty/nginx/conf/ssl/chuqufeng.cn.key  \</span><br><span class="line">--fullchain-file /usr/local/openresty/nginx/conf/ssl/cert.cer \</span><br><span class="line">--reloadcmd     <span class="string">&quot;sudo service nginx force-reload&quot;</span></span><br></pre></td></tr></table></figure>
<p>生成dhparam：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openssl dhparam -out /usr/local/openresty/nginx/conf/ssl/dhparam.pem 2048</span><br></pre></td></tr></table></figure>

<p>配置Nginx上证书</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">  <span class="comment">##开启 HTTPS 和 HTTP/2</span></span><br><span class="line">  listen 443 ssl http2;</span><br><span class="line"></span><br><span class="line">  <span class="comment">##证书部分</span></span><br><span class="line">  <span class="comment">#证书</span></span><br><span class="line">  ssl_certificate /usr/local/openresty/nginx/conf/ssl/cert.cer;</span><br><span class="line">  <span class="comment">#密钥</span></span><br><span class="line">  ssl_certificate_key /usr/local/openresty/nginx/conf/ssl/chuqufeng.cn.key;</span><br><span class="line">  <span class="comment">#ssl_dhparam</span></span><br><span class="line">  ssl_dhparam /usr/local/openresty/nginx/conf/ssl/dhparam.pem;</span><br><span class="line">  <span class="comment">##SSL增强安全设置部分</span></span><br><span class="line">  add_header Strict-Transport-Security max-age=15768000; <span class="comment">#HSTS设置</span></span><br><span class="line">  ssl_protocols TLSv1 TLSv1.1 TLSv1.2;</span><br><span class="line">  ssl_ciphers EECDH+CHACHA20:EECDH+CHACHA20-draft:EECDH+ECDSA+AES128:EECDH+aRSA+AES128:RSA+AES128:EECDH+ECDSA+AES256:EECDH+aRSA+AES256:RSA+AES256:EECDH+ECDSA+3DES:EECDH+aRSA+3DES:RSA+3DES:!MD5;</span><br><span class="line">  <span class="comment">#关键</span></span><br><span class="line">  ssl_prefer_server_ciphers on;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="6-重启openresty"><a href="#6-重启openresty" class="headerlink" title="6. 重启openresty"></a>6. 重启openresty</h4><blockquote>
<p>sudo service nginx restart</p>
</blockquote>
<h4 id="7-Result"><a href="#7-Result" class="headerlink" title="7. Result"></a>7. Result</h4><p>现在<a target="_blank" rel="noopener" href="https://www.ssllabs.com/">https://www.ssllabs.com</a> 评分为A+</p>
<p>参考文章：</p>
<p><a target="_blank" rel="noopener" href="https://www.textarea.com/zhicheng/fenxiang-yige-https-a-di-nginx-peizhi-320/">https://www.textarea.com/zhicheng/fenxiang-yige-https-a-di-nginx-peizhi-320/</a> </p>
<p><a target="_blank" rel="noopener" href="https://ruby-china.org/topics/31983">https://ruby-china.org/topics/31983</a></p>

      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    

    </div>

    
  </div>
</article>

  









    </main>

    <footer class="site-footer">
  <p class="site-info">
    Proudly powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and
    Theme by <a href="https://github.com/CodeDaraW/Hacker" target="_blank">Hacker</a>
    </br>
    
    &copy; 2022 大侠曾
    
  </p>
</footer>
    
    
  </div>
</div>
</body>
</html>